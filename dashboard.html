<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR ‚Üî INSDEV Dependency Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: rgba(17, 24, 39, 0.8);
            --border-color: rgba(99, 179, 237, 0.15);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-ar: #06b6d4;
            --accent-ar-glow: rgba(6, 182, 212, 0.3);
            --accent-insdev: #10b981;
            --accent-insdev-glow: rgba(16, 185, 129, 0.3);
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --accent-success: #22c55e;
            --link-line: rgba(148, 163, 184, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 20%, var(--accent-ar-glow) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, var(--accent-insdev-glow) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 60%);
            pointer-events: none;
            z-index: -1;
        }

        /* Header */
        .header {
            padding: 2rem 3rem;
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(10, 14, 23, 0.9);
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-ar), var(--accent-insdev));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(90deg, var(--accent-ar), var(--accent-insdev));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo p {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .header-stats {
            display: flex;
            gap: 2rem;
        }

        .header-stat {
            text-align: center;
        }

        .header-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Main layout */
        .main {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr 380px;
            gap: 2rem;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title::before {
            content: '';
            width: 8px;
            height: 8px;
            background: linear-gradient(135deg, var(--accent-ar), var(--accent-insdev));
            border-radius: 50%;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Graph container */
        .graph-card {
            grid-row: span 2;
        }

        .graph-container {
            height: 700px;
            position: relative;
        }

        #graph {
            width: 100%;
            height: 100%;
        }

        /* Graph styles */
        .node {
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .node:hover {
            transform: scale(1.1);
        }

        .node circle {
            stroke-width: 3px;
            filter: drop-shadow(0 0 8px currentColor);
        }

        .node.ar circle {
            fill: var(--accent-ar);
            stroke: rgba(6, 182, 212, 0.5);
        }

        .node.insdev circle {
            fill: var(--accent-insdev);
            stroke: rgba(16, 185, 129, 0.5);
        }

        .node text {
            fill: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 500;
            pointer-events: none;
        }

        .link-line {
            stroke: var(--link-line);
            stroke-width: 2px;
            fill: none;
        }

        .link-line.highlighted {
            stroke: var(--accent-warning);
            stroke-width: 3px;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 1.5rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-top: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.ar { background: var(--accent-ar); }
        .legend-dot.insdev { background: var(--accent-insdev); }

        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 600;
        }

        .stat-value.ar { color: var(--accent-ar); }
        .stat-value.insdev { color: var(--accent-insdev); }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        /* Dependencies list */
        .deps-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .dep-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .dep-item:hover {
            background: rgba(0, 0, 0, 0.4);
            transform: translateX(4px);
        }

        .dep-source, .dep-target {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            text-decoration: none;
            transition: opacity 0.2s;
        }

        .dep-source:hover, .dep-target:hover {
            opacity: 0.8;
        }

        .dep-source.ar, .dep-target.ar {
            background: rgba(6, 182, 212, 0.2);
            color: var(--accent-ar);
        }

        .dep-source.insdev, .dep-target.insdev {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-insdev);
        }

        .dep-arrow {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .dep-type {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-left: auto;
        }

        /* Status badges */
        .status-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .status-name {
            font-size: 0.875rem;
        }

        .status-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.1);
        }

        .status-item.done .status-count { background: rgba(34, 197, 94, 0.2); color: var(--accent-success); }
        .status-item.progress .status-count { background: rgba(6, 182, 212, 0.2); color: var(--accent-ar); }
        .status-item.todo .status-count { background: rgba(148, 163, 184, 0.2); color: var(--text-secondary); }

        /* Filters */
        .filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            font-family: 'Outfit', sans-serif;
            font-size: 0.8rem;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 999px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn:hover, .filter-btn.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border-color: var(--accent-ar);
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 1000;
            max-width: 320px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .tooltip-key {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 1rem;
        }

        .tooltip-key.ar { color: var(--accent-ar); }
        .tooltip-key.insdev { color: var(--accent-insdev); }

        .tooltip-summary {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .tooltip-meta {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Loading state */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            gap: 1rem;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-ar);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-muted);
        }

        /* Error state */
        .error {
            text-align: center;
            padding: 3rem;
        }

        .error-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .error-title {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .error-message {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        .error-btn {
            font-family: 'Outfit', sans-serif;
            padding: 0.75rem 1.5rem;
            background: var(--accent-ar);
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .error-btn:hover {
            transform: scale(1.05);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Dependency Table Styles */
        .table-card {
            grid-column: 1 / -1;
        }

        .table-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .table-select {
            font-family: 'Outfit', sans-serif;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
        }

        .table-select:focus {
            outline: none;
            border-color: var(--accent-ar);
        }

        .export-btn {
            font-family: 'Outfit', sans-serif;
            font-size: 0.875rem;
            padding: 0.5rem 1.25rem;
            background: linear-gradient(135deg, var(--accent-ar), var(--accent-insdev));
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
        }

        .table-body {
            padding: 0;
        }

        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        .dep-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .dep-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .dep-table th {
            background: rgba(0, 0, 0, 0.4);
            padding: 1rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
        }

        .dep-table th.sortable {
            cursor: pointer;
            user-select: none;
        }

        .dep-table th.sortable:hover {
            color: var(--accent-ar);
        }

        .dep-table th.sortable::after {
            content: ' ‚Üï';
            opacity: 0.4;
        }

        .dep-table th.sortable.asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }

        .dep-table th.sortable.desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }

        .dep-table td {
            padding: 0.875rem 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            vertical-align: top;
        }

        .dep-table tbody tr {
            transition: background 0.2s ease;
        }

        .dep-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .dep-table tbody tr.blocking-row {
            background: rgba(239, 68, 68, 0.1);
        }

        .dep-table tbody tr.blocking-row:hover {
            background: rgba(239, 68, 68, 0.15);
        }

        .ticket-link {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 500;
            text-decoration: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
            transition: all 0.2s ease;
        }

        .ticket-link.ar {
            background: rgba(6, 182, 212, 0.15);
            color: var(--accent-ar);
        }

        .ticket-link.insdev {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-insdev);
        }

        .ticket-link:hover {
            transform: translateY(-1px);
            filter: brightness(1.2);
        }

        .summary-cell {
            max-width: 250px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .status-badge.done {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-success);
        }

        .status-badge.in-progress {
            background: rgba(6, 182, 212, 0.2);
            color: var(--accent-ar);
        }

        .status-badge.in-review {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-warning);
        }

        .status-badge.open {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
        }

        .link-type-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .link-type-badge.blocks {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-danger);
        }

        .link-type-badge.relates {
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
        }

        .link-type-badge.gantt {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-warning);
        }

        .blocked-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .blocked-indicator.yes {
            color: var(--accent-danger);
        }

        .blocked-indicator.no {
            color: var(--accent-success);
        }

        .blocked-indicator.resolved {
            color: var(--text-muted);
        }

        /* Days blocked styles */
        .days-blocked {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .days-blocked.critical {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-danger);
        }

        .days-blocked.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-warning);
        }

        .days-blocked.normal {
            background: rgba(6, 182, 212, 0.2);
            color: var(--accent-ar);
        }

        .days-blocked.resolved {
            background: rgba(34, 197, 94, 0.1);
            color: var(--text-muted);
        }

        /* Notes column styles */
        .notes-cell {
            min-width: 200px;
        }

        .notes-container {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .notes-input {
            font-family: 'Outfit', sans-serif;
            font-size: 0.8rem;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            resize: vertical;
            min-height: 60px;
            max-height: 150px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .notes-input:focus {
            outline: none;
            border-color: var(--accent-ar);
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .notes-input::placeholder {
            color: var(--text-muted);
        }

        .notes-saved {
            font-size: 0.7rem;
            color: var(--accent-success);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .notes-saved.show {
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main {
                grid-template-columns: 1fr;
            }

            .graph-card {
                grid-row: span 1;
            }

            .graph-container {
                height: 500px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .main {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table-actions {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üîó</div>
                <div>
                    <h1>Dependency Dashboard</h1>
                    <p>AR ‚Üî INSDEV Cross-Project Dependencies</p>
                </div>
            </div>
            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-value" id="total-deps">-</div>
                    <div class="header-stat-label">Dependencies</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="total-issues">-</div>
                    <div class="header-stat-label">Issues</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="last-updated">-</div>
                    <div class="header-stat-label">Last Updated</div>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <!-- Dependency Table (Full Width) -->
        <div class="card table-card">
            <div class="card-header">
                <h2 class="card-title">AR to INSDEV Dependency Tracker</h2>
                <div class="table-actions">
                    <select id="table-filter" class="table-select">
                        <option value="all">All Dependencies</option>
                        <option value="blocking">Blocking Only</option>
                        <option value="open">Open/In Progress</option>
                        <option value="done">Completed</option>
                    </select>
                    <button class="export-btn" onclick="exportToCSV()">Export CSV</button>
                </div>
            </div>
            <div class="card-body table-body">
                <div class="table-container">
                    <table class="dep-table" id="dependency-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="ar-key">AR Ticket</th>
                                <th>AR Summary</th>
                                <th class="sortable" data-sort="ar-status">AR Status</th>
                                <th class="sortable" data-sort="insdev-key">INSDEV Ticket</th>
                                <th>INSDEV Summary</th>
                                <th class="sortable" data-sort="insdev-status">INSDEV Status</th>
                                <th>Blocked?</th>
                                <th class="sortable" data-sort="days-blocked">Days Blocked</th>
                                <th>Notes / Tracking</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Graph -->
        <div class="card graph-card">
            <div class="card-header">
                <h2 class="card-title">Dependency Graph</h2>
                <div class="filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="ar">AR Only</button>
                    <button class="filter-btn" data-filter="insdev">INSDEV Only</button>
                    <button class="filter-btn" data-filter="blocks">Blocking</button>
                </div>
            </div>
            <div class="card-body">
                <div class="graph-container" id="graph">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div class="loading-text">Loading dependency data...</div>
                    </div>
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <span class="legend-dot ar"></span>
                        <span>AR (Activation Reporting)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot insdev"></span>
                        <span>INSDEV</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Statistics</h2>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value ar" id="ar-count">-</div>
                        <div class="stat-label">AR Issues</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value insdev" id="insdev-count">-</div>
                        <div class="stat-label">INSDEV Issues</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="ar-to-insdev" style="color: var(--accent-warning);">-</div>
                        <div class="stat-label">AR -> INSDEV</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="insdev-to-ar" style="color: var(--accent-warning);">-</div>
                        <div class="stat-label">INSDEV -> AR</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status breakdown -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Status Breakdown</h2>
            </div>
            <div class="card-body">
                <div class="status-list" id="status-list">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </main>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip">
        <div class="tooltip-header">
            <span class="tooltip-key" id="tooltip-key"></span>
        </div>
        <div class="tooltip-summary" id="tooltip-summary"></div>
        <div class="tooltip-meta">
            <span id="tooltip-status"></span>
            <span id="tooltip-assignee"></span>
        </div>
    </div>

    <script>
        // Configuration
        const JIRA_URL = 'https://citrusad.atlassian.net';
        
        // Global state
        let graphData = null;
        let simulation = null;
        let currentFilter = 'all';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupFilterButtons();
        });

        async function loadData() {
            try {
                const response = await fetch('dependencies.json');
                if (!response.ok) throw new Error('Failed to load data');
                graphData = await response.json();
                renderDashboard();
            } catch (error) {
                showError(error.message);
            }
        }

        function showError(message) {
            document.getElementById('graph').innerHTML = `
                <div class="error">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-title">Data Not Found</div>
                    <div class="error-message">${message}<br><br>Run <code>python fetch_dependencies.py</code> first to generate the data.</div>
                    <button class="error-btn" onclick="location.reload()">Retry</button>
                </div>
            `;
        }

        function renderDashboard() {
            const { dependencies, nodes, stats, generated_at } = graphData;

            // Update header stats
            document.getElementById('total-deps').textContent = stats.total_dependencies;
            document.getElementById('total-issues').textContent = stats.total_nodes;
            document.getElementById('last-updated').textContent = new Date(generated_at).toLocaleDateString();

            // Update stat boxes
            document.getElementById('ar-count').textContent = stats.ar_count;
            document.getElementById('insdev-count').textContent = stats.insdev_count;
            
            const arToInsdev = dependencies.filter(d => d.source_project === 'AR').length;
            const insdevToAr = dependencies.filter(d => d.source_project === 'INSDEV').length;
            document.getElementById('ar-to-insdev').textContent = arToInsdev;
            document.getElementById('insdev-to-ar').textContent = insdevToAr;

            // Render dependency table
            renderDependencyTable(dependencies);

            // Render status breakdown
            renderStatusBreakdown(nodes);

            // Render graph
            renderGraph(nodes, dependencies);

            // Setup table filter
            setupTableFilter();
        }

        function renderDependencyTable(dependencies) {
            const tbody = document.getElementById('table-body');
            
            // Normalize data - ensure AR is always on the left, INSDEV on the right
            const tableData = dependencies.map(d => {
                let arKey, arSummary, arStatus, insdevKey, insdevSummary, insdevStatus, linkType, isBlocking;
                let arCreated, arUpdated, arStatusChanged;
                
                if (d.source_project === 'AR') {
                    arKey = d.source;
                    arSummary = d.source_summary;
                    arStatus = d.source_status;
                    arCreated = d.source_created || '';
                    arUpdated = d.source_updated || '';
                    arStatusChanged = d.source_status_changed || '';
                    insdevKey = d.target;
                    insdevSummary = d.target_summary;
                    insdevStatus = d.target_status;
                } else {
                    arKey = d.target;
                    arSummary = d.target_summary;
                    arStatus = d.target_status;
                    arCreated = d.target_created || '';
                    arUpdated = d.target_updated || '';
                    arStatusChanged = d.target_status_changed || '';
                    insdevKey = d.source;
                    insdevSummary = d.source_summary;
                    insdevStatus = d.source_status;
                }
                
                linkType = d.link_type;
                // AR is blocked if INSDEV blocks it and INSDEV is not done
                isBlocking = d.link_type.toLowerCase().includes('block') && 
                             d.source_project === 'INSDEV' && 
                             d.source_status !== 'Done';
                
                const isResolved = d.link_type.toLowerCase().includes('block') && 
                                  (d.source_status === 'Done' || d.target_status === 'Done');
                
                // Calculate days blocked (using AR ticket updated date - when link was likely added)
                let blockedSince = null;
                let daysBlocked = 0;
                
                if (isBlocking) {
                    // Use AR ticket updated date - approximates when the blocking link was added
                    const dateStr = arUpdated || arCreated;
                    if (dateStr) {
                        blockedSince = new Date(dateStr);
                        const now = new Date();
                        daysBlocked = Math.floor((now - blockedSince) / (1000 * 60 * 60 * 24));
                    }
                }
                
                // Priority score: Blocks > Gantt > Relates
                let priority = 0;
                if (linkType.toLowerCase().includes('block')) priority = 3;
                else if (linkType.toLowerCase().includes('gantt')) priority = 2;
                else priority = 1;
                
                return {
                    arKey, arSummary, arStatus,
                    insdevKey, insdevSummary, insdevStatus,
                    linkType, isBlocking, isResolved, priority,
                    blockedSince, daysBlocked,
                    raw: d
                };
            });
            
            // Remove duplicates - keep only ONE entry per AR-INSDEV pair
            // Prioritize: Blocks > Gantt > Relates
            const pairMap = new Map();
            tableData.forEach(row => {
                const key = `${row.arKey}-${row.insdevKey}`;
                const existing = pairMap.get(key);
                
                if (!existing || row.priority > existing.priority) {
                    pairMap.set(key, row);
                }
            });
            
            const uniqueData = Array.from(pairMap.values());
            
            // Sort by days blocked (descending), then by AR key
            uniqueData.sort((a, b) => {
                if (a.isBlocking && b.isBlocking) {
                    return b.daysBlocked - a.daysBlocked; // Most blocked first
                }
                if (a.isBlocking) return -1;
                if (b.isBlocking) return 1;
                return a.arKey.localeCompare(b.arKey);
            });
            
            // Store for filtering
            window.tableData = uniqueData;
            
            renderTableRows(uniqueData);
        }

        function renderTableRows(data) {
            const tbody = document.getElementById('table-body');
            
            tbody.innerHTML = data.map(row => {
                const arStatusClass = getStatusClass(row.arStatus);
                const insdevStatusClass = getStatusClass(row.insdevStatus);
                const linkTypeClass = getLinkTypeClass(row.linkType);
                const rowClass = row.isBlocking ? 'blocking-row' : '';
                
                let blockedHtml;
                if (row.linkType.toLowerCase().includes('block')) {
                    if (row.isBlocking) {
                        blockedHtml = '<span class="blocked-indicator yes">‚ö† Yes</span>';
                    } else if (row.isResolved) {
                        blockedHtml = '<span class="blocked-indicator resolved">‚úì Resolved</span>';
                    } else {
                        blockedHtml = '<span class="blocked-indicator no">‚úì No</span>';
                    }
                } else {
                    blockedHtml = '<span class="blocked-indicator" style="color: var(--text-muted);">N/A</span>';
                }
                
                // Calculate days blocked
                let daysBlockedHtml = '-';
                if (row.isBlocking && row.blockedSince) {
                    const days = row.daysBlocked || 0;
                    const colorClass = days > 14 ? 'critical' : days > 7 ? 'warning' : 'normal';
                    daysBlockedHtml = `<span class="days-blocked ${colorClass}">${days} days</span>`;
                } else if (row.isResolved) {
                    daysBlockedHtml = '<span class="days-blocked resolved">Resolved</span>';
                }
                
                const noteKey = `${row.arKey}-${row.insdevKey}`;
                const savedNote = getSavedNote(noteKey);
                
                return `
                    <tr class="${rowClass}" data-ar="${row.arKey}" data-insdev="${row.insdevKey}">
                        <td>
                            <a href="${JIRA_URL}/browse/${row.arKey}" target="_blank" class="ticket-link ar">${row.arKey}</a>
                        </td>
                        <td class="summary-cell">${row.arSummary}</td>
                        <td><span class="status-badge ${arStatusClass}">${row.arStatus}</span></td>
                        <td>
                            <a href="${JIRA_URL}/browse/${row.insdevKey}" target="_blank" class="ticket-link insdev">${row.insdevKey}</a>
                        </td>
                        <td class="summary-cell">${row.insdevSummary}</td>
                        <td><span class="status-badge ${insdevStatusClass}">${row.insdevStatus}</span></td>
                        <td>${blockedHtml}</td>
                        <td>${daysBlockedHtml}</td>
                        <td class="notes-cell">
                            <div class="notes-container">
                                <textarea class="notes-input" 
                                          data-key="${noteKey}" 
                                          placeholder="Add notes..."
                                          onchange="saveNote(this)">${savedNote}</textarea>
                                <span class="notes-saved" id="saved-${noteKey}"></span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getStatusClass(status) {
            const s = status.toLowerCase();
            if (s === 'done') return 'done';
            if (s.includes('progress')) return 'in-progress';
            if (s.includes('review')) return 'in-review';
            return 'open';
        }

        function getLinkTypeClass(linkType) {
            const lt = linkType.toLowerCase();
            if (lt.includes('block')) return 'blocks';
            if (lt.includes('relat')) return 'relates';
            if (lt.includes('gantt')) return 'gantt';
            return '';
        }

        function setupTableFilter() {
            const filter = document.getElementById('table-filter');
            filter.addEventListener('change', (e) => {
                const value = e.target.value;
                let filtered = window.tableData;
                
                if (value === 'blocking') {
                    filtered = window.tableData.filter(r => r.isBlocking);
                } else if (value === 'open') {
                    filtered = window.tableData.filter(r => 
                        r.arStatus !== 'Done' || r.insdevStatus !== 'Done'
                    );
                } else if (value === 'done') {
                    filtered = window.tableData.filter(r => 
                        r.arStatus === 'Done' && r.insdevStatus === 'Done'
                    );
                }
                
                renderTableRows(filtered);
            });
        }

        // Notes storage functions
        const NOTES_STORAGE_KEY = 'ar-insdev-dependency-notes';

        function getAllNotes() {
            try {
                const stored = localStorage.getItem(NOTES_STORAGE_KEY);
                return stored ? JSON.parse(stored) : {};
            } catch (e) {
                console.error('Error loading notes:', e);
                return {};
            }
        }

        function getSavedNote(key) {
            const notes = getAllNotes();
            return notes[key] || '';
        }

        function saveNote(textarea) {
            const key = textarea.dataset.key;
            const value = textarea.value.trim();
            
            try {
                const notes = getAllNotes();
                
                if (value) {
                    notes[key] = value;
                } else {
                    delete notes[key];
                }
                
                localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(notes));
                
                // Show saved indicator
                const savedIndicator = document.getElementById(`saved-${key}`);
                if (savedIndicator) {
                    savedIndicator.textContent = '‚úì Saved';
                    savedIndicator.classList.add('show');
                    setTimeout(() => {
                        savedIndicator.classList.remove('show');
                    }, 2000);
                }
            } catch (e) {
                console.error('Error saving note:', e);
            }
        }

        function exportToCSV() {
            const data = window.tableData;
            const notes = getAllNotes();
            const headers = ['AR Ticket', 'AR Summary', 'AR Status', 'INSDEV Ticket', 'INSDEV Summary', 'INSDEV Status', 'Blocked', 'Notes'];
            
            const csvContent = [
                headers.join(','),
                ...data.map(row => {
                    const noteKey = `${row.arKey}-${row.insdevKey}`;
                    const note = notes[noteKey] || '';
                    return [
                        row.arKey,
                        `"${row.arSummary.replace(/"/g, '""')}"`,
                        row.arStatus,
                        row.insdevKey,
                        `"${row.insdevSummary.replace(/"/g, '""')}"`,
                        row.insdevStatus,
                        row.isBlocking ? 'Yes' : (row.isResolved ? 'Resolved' : 'No'),
                        `"${note.replace(/"/g, '""')}"`
                    ].join(',');
                })
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ar-insdev-dependencies-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function renderStatusBreakdown(nodes) {
            const statusCounts = {};
            nodes.forEach(n => {
                const status = n.status || 'Unknown';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const sorted = Object.entries(statusCounts).sort((a, b) => b[1] - a[1]);
            const container = document.getElementById('status-list');
            
            container.innerHTML = sorted.map(([status, count]) => {
                const statusClass = status.toLowerCase().includes('done') ? 'done' : 
                                   status.toLowerCase().includes('progress') ? 'progress' : 'todo';
                return `
                    <div class="status-item ${statusClass}">
                        <span class="status-name">${status}</span>
                        <span class="status-count">${count}</span>
                    </div>
                `;
            }).join('');
        }

        function renderGraph(nodes, dependencies) {
            const container = document.getElementById('graph');
            container.innerHTML = '';

            const width = container.clientWidth;
            const height = container.clientHeight;

            const svg = d3.select('#graph')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Create arrow marker
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '-0 -5 10 10')
                .attr('refX', 25)
                .attr('refY', 0)
                .attr('orient', 'auto')
                .attr('markerWidth', 8)
                .attr('markerHeight', 8)
                .append('path')
                .attr('d', 'M 0,-5 L 10,0 L 0,5')
                .attr('fill', 'var(--link-line)');

            // Prepare data
            const nodeMap = new Map(nodes.map(n => [n.id, n]));
            const links = dependencies.map(d => ({
                source: d.source,
                target: d.target,
                type: d.link_type
            }));

            // Force simulation
            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(120))
                .force('charge', d3.forceManyBody().strength(-400))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(40));

            // Draw links
            const link = svg.append('g')
                .selectAll('line')
                .data(links)
                .join('line')
                .attr('class', 'link-line')
                .attr('marker-end', 'url(#arrowhead)');

            // Draw nodes
            const node = svg.append('g')
                .selectAll('.node')
                .data(nodes)
                .join('g')
                .attr('class', d => `node ${d.project.toLowerCase()}`)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            node.append('circle')
                .attr('r', 20);

            node.append('text')
                .text(d => d.id)
                .attr('dy', 4)
                .attr('text-anchor', 'middle');

            // Tooltip interactions
            const tooltip = document.getElementById('tooltip');
            
            node.on('mouseenter', (event, d) => {
                tooltip.classList.add('visible');
                document.getElementById('tooltip-key').textContent = d.id;
                document.getElementById('tooltip-key').className = `tooltip-key ${d.project.toLowerCase()}`;
                document.getElementById('tooltip-summary').textContent = d.summary || 'No summary';
                document.getElementById('tooltip-status').textContent = `Status: ${d.status}`;
                document.getElementById('tooltip-assignee').textContent = d.assignee ? `Assignee: ${d.assignee}` : '';
            })
            .on('mousemove', (event) => {
                tooltip.style.left = `${event.pageX + 15}px`;
                tooltip.style.top = `${event.pageY + 15}px`;
            })
            .on('mouseleave', () => {
                tooltip.classList.remove('visible');
            })
            .on('click', (event, d) => {
                window.open(d.url, '_blank');
            });

            // Simulation tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            // Drag functions
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            // Store references for filtering
            window.graphElements = { svg, node, link, nodes, links };
        }

        function setupFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    applyFilter();
                });
            });
        }

        function applyFilter() {
            if (!window.graphElements) return;
            const { node, link } = window.graphElements;

            node.style('opacity', d => {
                if (currentFilter === 'all') return 1;
                if (currentFilter === 'ar') return d.project === 'AR' ? 1 : 0.2;
                if (currentFilter === 'insdev') return d.project === 'INSDEV' ? 1 : 0.2;
                return 1;
            });

            link.style('opacity', d => {
                if (currentFilter === 'all') return 1;
                if (currentFilter === 'blocks') return d.type.toLowerCase().includes('block') ? 1 : 0.1;
                return 0.3;
            });
        }

        function highlightLink(source, target) {
            if (!window.graphElements) return;
            const { link } = window.graphElements;

            link.classed('highlighted', d => 
                (d.source.id === source && d.target.id === target) ||
                (d.source.id === target && d.target.id === source)
            );
        }

        function clearHighlights() {
            if (!window.graphElements) return;
            const { link } = window.graphElements;
            link.classed('highlighted', false);
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            if (graphData) {
                renderGraph(graphData.nodes, graphData.dependencies);
            }
        });
    </script>
</body>
</html>
